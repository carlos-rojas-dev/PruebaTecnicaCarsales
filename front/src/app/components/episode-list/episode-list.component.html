<div class="episode-container">
  <h1>Episodios</h1>
  
  <!-- Search Filter -->
  <div class="search-container">
    <div class="search-box">
      <input 
        type="text" 
        placeholder="Buscar episodio por nombre..." 
        [(ngModel)]="searchTerm"
        (input)="onSearchChange($event.target.value)"
        class="search-input"
      />
      <button 
        *ngIf="hasActiveFilter()" 
        (click)="clearSearch()" 
        class="clear-btn"
        title="Limpiar b√∫squeda"
      >
        ‚úï
      </button>
    </div>
    @if (hasActiveFilter()) {
      <div class="search-results">
        <span class="results-count">
          {{ getFilteredCount() }} de {{ episodes.length }} episodios encontrados
        </span>
      </div>
    }
  </div>
  
  @if (loading) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando episodios...</p>
    </div>
  }

  @if (error) {
    <div class="error">
      <p>{{ error }}</p>
      <button (click)="loadEpisodes(currentPage)" class="retry-btn">Reintentar</button>
    </div>
  }

  @if (!loading && !error && episodes.length > 0) {
    <!-- Grid de episodios filtrados -->
    @if (filteredEpisodes.length > 0) {
      <div class="episodes-grid">
        @for (episode of filteredEpisodes; track episode.id) {
        <div class="episode-card">
          <div class="card-header">
            <h3>{{ episode.name }}</h3>
            <span class="episode-number">{{ episode.episode }}</span>
          </div>
          
          <div class="card-content">
            <div class="episode-info">
              <p><strong>Fecha de emisi√≥n:</strong> {{ formatDate(episode.air_date) }}</p>
              <p>
                <strong>Personajes:</strong> 
                <span 
                  class="characters-link" 
                  (click)="viewEpisodeCharacters(episode.id)"
                  title="Ver personajes del episodio">
                  {{ episode.characters.length || 0 }} personajes
                </span>
              </p>
            </div>
            
            <div class="card-footer">
              <small>ID: {{ episode.id }}</small>
              <small>Creado: {{ formatDate(episode.created) }}</small>
            </div>
          </div>
        </div>
      }
    </div>
    } @else {
      <div class="no-results">
        <div class="no-results-icon">üîç</div>
        <h3>No se encontraron episodios</h3>
        <p>No hay episodios que coincidan con "{{ searchTerm }}"</p>
        <button (click)="clearSearch()" class="clear-search-btn">
          Limpiar b√∫squeda
        </button>
      </div>
    }

    <!-- Controles de paginaci√≥n -->
    <div class="pagination-controls">
      <button 
        (click)="previousPage()" 
        [disabled]="currentPage === 1"
        class="pagination-btn">
        ‚Üê Anterior
      </button>
      
      <div class="page-numbers">
        @for (page of getPageNumbers(); track page) {
          <button 
            (click)="goToPage(page)"
            [class.active]="page === currentPage"
            class="page-btn">
            {{ page }}
          </button>
        }
      </div>
      
      <button 
        (click)="nextPage()" 
        [disabled]="currentPage === totalPages"
        class="pagination-btn">
        Siguiente ‚Üí
      </button>
    </div>
  }

  @if (!loading && !error && episodes.length === 0) {
    <div class="no-data">
      <p>No se encontraron episodios.</p>
      <button (click)="loadEpisodes(1)" class="retry-btn">Recargar</button>
    </div>
  }

  <!-- Modal de Personajes -->
  @if (showModal) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Personajes de: {{ selectedEpisodeName }}</h2>
          <button class="modal-close-btn" (click)="closeModal()" title="Cerrar modal">
            ‚úï
          </button>
        </div>

        <div class="modal-body">
          @if (modalLoading) {
            <div class="modal-loading">
              <div class="spinner"></div>
              <p>Cargando personajes...</p>
            </div>
          }

          @if (modalError) {
            <div class="modal-error">
              <p>{{ modalError }}</p>
              <button (click)="retryLoadCharacters()" class="retry-btn">Reintentar</button>
            </div>
          }

          @if (!modalLoading && !modalError && characters.length > 0) {
            <!-- Character Search -->
            <div class="character-search-container">
              <div class="character-search-box">
                <input 
                  type="text" 
                  placeholder="Buscar personaje por nombre, especie, estado..." 
                  [(ngModel)]="characterSearchTerm"
                  (input)="onCharacterSearchChange($event.target.value)"
                  class="character-search-input"
                />
                <button 
                  *ngIf="hasCharacterSearchActive()" 
                  (click)="clearCharacterSearch()" 
                  class="character-clear-btn"
                  title="Limpiar b√∫squeda"
                >
                  ‚úï
                </button>
              </div>
              @if (hasCharacterSearchActive()) {
                <div class="character-search-results">
                  <span class="character-results-count">
                    {{ getFilteredCharactersCount() }} de {{ characters.length }} personajes encontrados
                  </span>
                </div>
              }
            </div>
            @if (filteredCharacters.length > 0) {
              <div class="characters-grid">
                @for (character of filteredCharacters; track character.id) {
                  <div class="character-card">
                    <div class="character-info">
                      <h3>{{ character.name || 'Sin nombre' }}</h3>
                      
                      <div class="character-details">
                        @if (character.status) {
                          <span class="status-badge" [class]="'status-' + character.status.toLowerCase()">
                            {{ character.status }}
                          </span>
                        } @else {
                          <span class="status-badge status-unknown">Sin estado</span>
                        }
                        
                        <p><strong>Especie:</strong> {{ character.species || 'No especificada' }}</p>
                        <p><strong>G√©nero:</strong> {{ character.gender || 'No especificado' }}</p>
                        <p><strong>Origen:</strong> {{ character.origin.name || 'Desconocido' }}</p>
                        <p><strong>Ubicaci√≥n:</strong> {{ character.location.name || 'Desconocida' }}</p>
                      </div>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="character-no-results">
                <div class="character-no-results-icon">üîç</div>
                <h3>No se encontraron personajes</h3>
                <p>No hay personajes que coincidan con "{{ characterSearchTerm }}"</p>
                <button (click)="clearCharacterSearch()" class="character-clear-search-btn">
                  Limpiar b√∫squeda
                </button>
              </div>
            }
          }

          @if (!modalLoading && !modalError && characters.length === 0) {
            <div class="modal-no-data">
              <p>No se encontraron personajes para este episodio.</p>
            </div>
          }
        </div>

        <div class="modal-footer">
          <button (click)="closeModal()" class="modal-close-button">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  }
</div>
